<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>مسابقة</title>
<style>
body {
    font-family: Arial;
    color: black;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 0;
    background-image: url('https://i.postimg.cc/FspKR1F7/IMG-7369.jpg');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
}

.box {
    background: #BBB8A5;
    padding: 20px;
    border-radius: 10px;
    width: 400px;
    border: 5px solid #8B4513;
    color: black;
}

#nameStep, #questionStep, #resultStep, #adminLogin, #adminPanel {
    padding: 10px;
    border-radius: 10px;
    border: 5px solid #8B4513;
    background: #BBB8A5;
    margin-top: 10px;
}

input, textarea, button {
    width: 100%;
    padding: 10px;
    margin: 10px 0;
    font-size: 16px;
    border-radius: 5px;
    border: 5px solid #8B4513;
    background: #BBB8A5;
    color: black;
}

#nameStep button {
    background: #BBB8A5;
    color: black;
    border: 5px solid #8B4513;
    font-weight: bold;
}

button:hover {
    background: #C7C3AF;
}

#contestMedia iframe,
#contestMedia img { 
    border-radius: 10px; 
    width: 100%; 
    border: 5px solid #8B4513;
}
</style>
</head>
<body>

<div class="box" id="mainBox">

    <h2>المسابقة</h2>

    <div id="nameStep">
        <label>ادخل اسمك:</label>
        <input type="text" id="playerName">
        <button onclick="start()">ابدأ</button>
    </div>

    <div id="questionStep" style="display:none;">
        <h3>السؤال:</h3>
        <div id="contestMedia"></div>
        <p id="questionText">السؤال سيتم عرضه بعد التفعيل من المالك</p>
        <input type="text" id="answerInput" placeholder="اكتب إجابتك">
        <button onclick="submitAnswer()">إرسال الإجابة</button>
    </div>

    <div id="resultStep" style="display:none;">
        <h3>تم تسجيل إجابتك</h3>
        <p id="playerScore"></p>
        <button onclick="showAdminLogin()">للمالك فقط</button>
    </div>

    <div id="adminLogin" style="display:none;">
        <input type="password" id="adminPass" placeholder="ادخل كلمة السر">
        <button onclick="adminCheck()">دخول</button>
    </div>

    <div id="adminPanel" style="display:none;">
        <h3>ترتيب المشتركين</h3>
        <ol id="ranking"></ol>

        <h3>تغيير السؤال</h3>
        <textarea id="newQuestion" style="width:100%; height:80px;"></textarea>
        <input type="text" id="newAnswer" placeholder="الإجابة الصحيحة الجديدة">
        <input type="text" id="newMedia" placeholder="رابط صورة/يوتيوب/Streamable/Vimeo">
        <button onclick="updateQuestion()">تحديث السؤال</button>
        <button onclick="resetPoints()">تصفير جميع النقاط</button>
        <button onclick="deletePlayers()">حذف جميع المشتركين</button>
        <input type="text" id="deletePlayerName" placeholder="حذف لاعب بعينه">
        <button onclick="deleteSinglePlayer()">حذف اللاعب</button>
    </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, set, get, child, update, remove, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBFv34RKK0gUg8-E1DA-mWorXwHpVTB2yc",
  authDomain: "ljfs-1d050.firebaseapp.com",
  databaseURL: "https://ljfs-1d050-default-rtdb.firebaseio.com",
  projectId: "ljfs-1d050",
  storageBucket: "ljfs-1d050.firebasestorage.app",
  messagingSenderId: "701021028104",
  appId: "1:701021028104:web:1670f347f35c2b1bd576bd"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let currentPlayer = null;
let questionOpen = false;

const questionRef = ref(db, 'currentQuestion');
const mediaRef = ref(db, 'currentMedia');

onValue(questionRef, (snapshot) => {
    const question = snapshot.val();
    if(question) document.getElementById('questionText').innerText = question;
});

onValue(mediaRef, (snapshot) => {
    const mediaUrl = snapshot.val();
    if(mediaUrl) updateMediaDisplay(mediaUrl);
});

function updateMediaDisplay(url){
    let container = document.getElementById("contestMedia");
    if(!url || url.trim()===""){ container.innerHTML = ""; return; }

    if(url.match(/\.(jpg|png|jpeg|gif)$/)){
        container.innerHTML = `<img src="${url}">`;
    } 
    else if(url.includes("youtube.com") || url.includes("youtu.be")){
        let id = (url.split("v=")[1] || url.split("youtu.be/")[1] || "").split("&")[0];
        container.innerHTML = `<iframe src="https://www.youtube.com/embed/${id}" height="300" frameborder="0" allowfullscreen></iframe>`;
    } 
    else if(url.includes("streamable.com")){
        let id = url.split("/").pop();
        container.innerHTML = `<iframe src="https://streamable.com/e/${id}" height="300" frameborder="0" allowfullscreen></iframe>`;
    } 
    else if(url.includes("vimeo.com")){
        let idMatch = url.match(/vimeo\.com\/(\d+)/);
        if(idMatch && idMatch[1]){
            container.innerHTML = `<iframe src="https://player.vimeo.com/video/${idMatch[1]}" height="300" frameborder="0" allowfullscreen></iframe>`;
        } else {
            container.innerHTML = `<iframe src="${url}" height="300" frameborder="0" allowfullscreen></iframe>`;
        }
    } 
    else {
        container.innerHTML = `<iframe src="${url}" height="300" frameborder="0" allowfullscreen></iframe>`;
    }
}

window.start = function() {
    if(!questionOpen){
        alert("انتظر فتح السؤال من المالك");
        return;
    }
    let name = document.getElementById("playerName").value.trim();
    if(name==="") return alert("اكتب اسمك");
    currentPlayer = name;

    get(child(ref(db), `answered/${name}`)).then((snapshot)=>{
        if(snapshot.exists()){
            alert("لقد أجبت مسبقًا. انتظر تغيير السؤال.");
        } else {
            set(ref(db, `players/${name}`), {score: 0});
            document.getElementById("nameStep").style.display="none";
            document.getElementById("questionStep").style.display="block";
        }
    });
}

window.submitAnswer = function(){
    let ans = document.getElementById("answerInput").value.trim();
    get(child(ref(db), `players/${currentPlayer}/score`)).then((snapshot)=>{
        let prevScore = snapshot.exists() ? snapshot.val() : 0;
        let earned = (ans == "2025" ? 3 : 0);
        update(ref(db, `players/${currentPlayer}`), {score: prevScore + earned});
        set(ref(db, `answered/${currentPlayer}`), true);
        document.getElementById("questionStep").style.display="none";
        document.getElementById("resultStep").style.display="block";
        document.getElementById("playerScore").innerText = "نقاطك: " + (prevScore + earned);
    });
}

window.showAdminLogin = function(){ document.getElementById("adminLogin").style.display="block"; }

window.adminCheck = function(){
    if(document.getElementById("adminPass").value === "Dosary"){
        showRanking();
        document.getElementById("adminPanel").style.display="block";
    } else { alert("كلمة السر غلط"); }
}

window.showRanking = function(){
    get(child(ref(db), `players`)).then((snapshot)=>{
        let list = document.getElementById("ranking");
        list.innerHTML="";
        if(snapshot.exists()){
            let data = snapshot.val();
            Object.entries(data).sort((a,b)=>b[1].score-a[1].score)
            .forEach(p=>{
                let li = document.createElement("li");
                li.innerText = p[0]+" : "+p[1].score+" نقاط";
                list.appendChild(li);
            });
        }
    });
}

// تحديث السؤال والوسائط من قبل المالك وفتح السؤال
window.updateQuestion = function(){
    let q = document.getElementById("newQuestion").value.trim();
    let a = document.getElementById("newAnswer").value.trim();
    let m = document.getElementById("newMedia").value.trim();
    if(!q || !a) return alert("اكتب السؤال والإجابة");
    update(ref(db), {
        currentQuestion: q,
        currentAnswer: a,
        currentMedia: m,
        answered: {}
    });
    questionOpen = true;
    alert("تم تحديث السؤال وفتحه للمشتركين");
}

window.resetPoints = function(){
    if(confirm("هل تريد تصفير النقاط؟")){
        get(child(ref(db), `players`)).then(snapshot=>{
            if(snapshot.exists()){
                Object.keys(snapshot.val()).forEach(name=>{
                    update(ref(db, `players/${name}`), {score:0});
                });
            }
        });
        showRanking();
        alert("تم التصفير");
    }
}

window.deletePlayers = function(){
    if(confirm("هل تريد حذف جميع المشتركين؟")){
        set(ref(db, `players`), {});
        set(ref(db, `answered`), {});
        alert("تم الحذف");
        location.reload();
    }
}

window.deleteSinglePlayer = function(){
    let name = document.getElementById("deletePlayerName").value.trim();
    if(name==="") return alert("اكتب اسم اللاعب");
    remove(ref(db, `players/${name}`));
    remove(ref(db, `answered/${name}`));
    showRanking();
    alert("تم حذف اللاعب: " + name);
}
</script>

</body>
</html>
